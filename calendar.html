<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Greyhawk Calendar</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
        }

        .calendar {
            display: inline-block;
        }

        .display {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .datetime-group {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            background-color: #ffa6e9;
        }

        .datetime-field {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .controls button {
            padding: 0.25rem 0.5rem;
            font-size: 0.5rem;
        }

        button {
            margin: 0;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .tight-button-group button {
            margin-right: 2px;
        }

        .date-part {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }

        .calendar-table {
            border-radius: 6px;
        }

        .calendar-table table {
            width: auto;
            margin: 0 auto;
            height: 120px;
        }

        .calendar-table td {
            width: 80px;
        }

        .calendar-table td.day-cell {
            width: 0px;
        }

        .calendar-table td.time-cell {
            width: 120px;
        }

        .calendar-table img {
            display: block;
            margin: 0 auto 0.05rem;
            height: 48px;
        }

        .title img {
            display: block;
            margin: 0 auto 0.05rem;
            height: 120px;
        }

        .icon-row td {
            vertical-align: bottom;
        }

        .icon-label-row td {
            vertical-align: top;
        }

        .weather-cell-right {
            vertical-align: middle;
            text-align: right;
        }

        .cell-middle-right {
            vertical-align: middle;
            text-align: right;
        }

        .cell-upper-left {
            vertical-align: top;
            text-align: left;
        }

        .cell-middle-left {
            vertical-align: middle;
            text-align: left;
        }

        .cell-lower-left {
            vertical-align: bottom;
            text-align: left;
        }

        .datetime-table {
            background-color: #ffdcdc;
        }

        .celestial-table {
            background-color: #f7fbe5;
        }

        .weather-table {
            background-color: #cbeee7;
        }

        .tide-table {
            background-color: #c6e1e6;
        }

        .moon-cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* height: 100px; */
        }

        .moon-cell img {
            width: 48px;
            height: auto;
            flex-shrink: 0;
        }

        .weekday {
            font-size: 2rem;
            font-weight: bold;
            font-variant: small-caps;
            text-shadow: 2px 2px #a0a0a0;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        h1 {
            margin-bottom: 0.5rem;
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-box {
            display: none;
            position: absolute;
            bottom: 110%;
            right: 0;
            background-color: #222;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            width: 260px;
            font-size: 0.85rem;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .wind-tooltip-content dt {
            font-weight: bold;
            margin-top: 6px;
        }

        .wind-tooltip-content dd {
            margin: 0 0 4px 0;
        }

        #btn-save-state {
            background-color: #dcdcdc;
            color: #444;
            border: 1px solid #aaa;
            transition: background-color 0.3s, color 0.3s;
        }

        #btn-save-state.unsaved {
            background-color: #c6e1e6;
            color: #000;
            border-color: #b6d1e6;
            font-weight: bold;
            box-shadow: 0 0 5px #96a1a680;
        }

        @keyframes savePulse {
            0% {
                box-shadow: 0 0 0 rgba(0, 0, 0, 0);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 10px#c6e1e6c0;
                transform: scale(1.05);
            }

            100% {
                box-shadow: 0 0 0 rgba(0, 0, 0, 0);
                transform: scale(1);
            }
        }

        #btn-save-state.save-animated {
            animation: savePulse 0.6s ease;
        }
    </style>
</head>

<body>
    <div class="calendar">
        <!-- <h1>Greyhawk Calendar</h1> -->
        <div class="title">
            <img src="images/TheWorldOfGreyhawkCalendar.svg">
        </div>
        <div id="weekday-display" class="weekday"></div>
        <div class="calendar-table datetime-table">
            <table>
                <tr>
                    <th>Year</th>
                    <th>Month</th>
                    <th class="day-cell">Day</th>
                    <th class="time-cell">Time</th>
                </tr>
                <tr>
                    <td><button id="btn-year-up">‚ñ≤</button></td>
                    <td><button id="btn-month-up">‚ñ≤</button></td>
                    <td class="day-cell"><button id="btn-day-up">‚ñ≤</button></td>
                    <td class="time-cell">
                        <button id="btn-hour-up">‚ñ≤</button>
                        <button id="btn-minute-up">‚ñ≤</button>
                        <button id="btn-round-up">‚ñ≤</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="display-year" class="date-part"></div>
                    </td>
                    <td>
                        <div id="display-month" class="date-part"></div>
                    </td>
                    <td class="day-cell">
                        <div id="display-day" class="date-part"></div>
                    </td>
                    <td class="time-cell">
                        <div id="display-hour" class="date-part"></div>
                    </td>
                </tr>
                <tr>
                    <td><button id="btn-year-down">‚ñº</button></td>
                    <td><button id="btn-month-down">‚ñº</button></td>
                    <td><button id="btn-day-down">‚ñº</button></td>
                    <td class="time-cell">
                        <button id="btn-hour-down">‚ñº</button>
                        <button id="btn-minute-down">‚ñº</button>
                        <button id="btn-round-down">‚ñº</button>
                    </td>
                </tr>
            </table>
        </div>
        <div class="calendar-table celestial-table">
            <table id="celestial-info"></table>
        </div>
        <div class="calendar-table weather-table">
            <table id="weather-info"></table>
        </div>
        <div class="calendar-table tide-table">
            <table id="tide-info"></table>
        </div>
        <label for="latitude-slider">
            Latitude:
            <input type="range" id="latitude-slider" min="0" max="90" value="38"
                title="Adjusts daylight and average temperature. Lower values simulate warmer regions or lower elevations. Higher values simulate colder regions or mountains." />
            <span id="latitude-value">38¬∞</span>
        </label>

        <div class="save-load-controls">
            <button id="btn-save-state">Save</button>
            <button id="btn-load-state">Load</button>
            <input type="file" id="file-input" style="display:none;" />
        </div>

    </div>

    <script>
        //
        // Global Constants and Variables
        //
        const totalDays = 360; // days in a year
        const lastKingTide = 888 // random offset of moons' position

        let isDirty = false; // calendar has unsaved changes

        let currentDay = 0.0; // total day count since CY 576
        let currentLatitude = 38; // Saltmarsh
        let weatherState = {
            lastUpdateTime: null,
            timeToChangeWeather: 0.0,
            continuation: null,
            high: null,
            low: null,
            temp: null,
            sky: null,
            skyRoll: null,
            precipRoll: null,
            hasPrecip: false,
            precipType: "",
            windSpeed: null
        };

        //
        // Utilities
        //
        function formatHour(decimalHour) {
            const totalMinutes = Math.round(decimalHour * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const padded = minutes.toString().padStart(2, '0');
            return `${hours}:${padded}`;
        }

        function rollDice(expression) {
            const match = expression.match(/^(\d*)d(\d+)([+-]\d+)?$/);
            if (!match) {
                console.warn(`Invalid dice expression: ${expression}`);
                return 0;
            }

            const numDice = parseInt(match[1]) || 1;
            const dieSides = parseInt(match[2]);
            const modifier = parseInt(match[3]) || 0;

            let total = 0;
            for (let i = 0; i < numDice; i++) {
                total += Math.floor(Math.random() * dieSides) + 1;
            }
            return total + modifier;
        }

        function saveStateToFile() {
            const data = {
                currentDay,
                weatherState,
                currentLatitude
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            const timestamp = new Date().toISOString().slice(0, 10); // e.g., "2025-03-30"
            a.download = `greyhawk-calendar-${timestamp}.json`;
            a.click();

            URL.revokeObjectURL(url);

            isDirty = false;
            updateSaveButtonStyle();

            const btn = document.getElementById("btn-save-state");
            btn.classList.add("save-animated");

            // Remove animation class after it finishes
            setTimeout(() => {
                btn.classList.remove("save-animated");
            }, 600);

        }
        function loadStateFromFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (typeof data.currentDay === "number" && typeof data.weatherState === "object") {
                        currentDay = data.currentDay;
                        weatherState = data.weatherState;

                        // Restore latitude (with fallback)
                        currentLatitude = typeof data.currentLatitude === "number" ? data.currentLatitude : 38;
                        document.getElementById("latitude-slider").value = currentLatitude;
                        document.getElementById("latitude-value").textContent = `${currentLatitude}¬∞`;

                        updateDisplay();
                    } else {
                        alert("Invalid file format.");
                    }
                } catch (e) {
                    alert("Failed to parse file.");
                }
            };
            reader.readAsText(file);

            isDirty = false;
            updateSaveButtonStyle();

        }
        function markDirty() {
            isDirty = true;
            updateSaveButtonStyle();
        }
        function updateSaveButtonStyle() {
            const btn = document.getElementById("btn-save-state");
            if (isDirty) {
                btn.classList.add("unsaved");
                btn.classList.remove("saved");
            } else {
                btn.classList.add("saved");
                btn.classList.remove("unsaved");
            }
        }

        //
        // Calendar
        //
        function getDayInYear(currentDay) {
            return (Math.floor(currentDay) % totalDays + totalDays) % totalDays;
        }

        const calendarStructure = [
            { name: "Needfest", days: 6 },
            { name: "Fireseek", days: 28 },
            { name: "Readying", days: 28 },
            { name: "Coldeven", days: 28 },
            { name: "Growfest", days: 6 },
            { name: "Planting", days: 28 },
            { name: "Flocktime", days: 28 },
            { name: "Wealsun", days: 28 },
            { name: "Richfest", days: 6 },
            { name: "Reaping", days: 28 },
            { name: "Goodmonth", days: 28 },
            { name: "Harvester", days: 28 },
            { name: "Brewfest", days: 6 },
            { name: "Patchwall", days: 28 },
            { name: "Ready‚Äôreat", days: 28 },
            { name: "Sunsebb", days: 28 }
        ];

        const dayToMonth = []; // index: 0‚Äì359 ‚Üí { name, day }
        (function generateDayMapping() {
            let dayOfYear = 0;
            for (const entry of calendarStructure) {
                for (let i = 1; i <= entry.days; i++) {
                    dayToMonth.push({ name: entry.name, day: i });
                    dayOfYear++;
                }
            }
        })();

        function getCalendarDate(dayOffset) {
            const dayInYear = getDayInYear(dayOffset);
            const entry = dayToMonth[dayInYear];
            return `${entry.day} ${entry.name}`;
        }
        function changeRounds(delta) {
            currentDay += delta / 24 / 60 / 10;
            updateDisplay();
            markDirty();
        }
        function changeMinutes(delta) {
            currentDay += delta / 24 / 60;
            updateDisplay();
            markDirty();
        }
        function changeHours(delta) {
            currentDay += delta / 24;
            updateDisplay();
            markDirty();
        }
        function changeDays(delta) {
            currentDay += delta;
            updateDisplay();
            markDirty();
        }
        function changeYears(delta) {
            currentDay += delta * totalDays;
            updateDisplay();
            markDirty();
        }
        function getMonthIndex(dayInYear) {
            let dayCount = 0;
            for (let i = 0; i < calendarStructure.length; i++) {
                const monthLength = calendarStructure[i].days;
                if (dayInYear < dayCount + monthLength) {
                    return i;
                }
                dayCount += monthLength;
            }
            return calendarStructure.length - 1; // fallback
        }

        function changeMonths(delta) {
            const dayInYear = (Math.floor(currentDay) % totalDays + totalDays) % totalDays;
            const currentMonthIndex = getMonthIndex(dayInYear);
            const daysInCurrentMonth = calendarStructure[currentMonthIndex].days;

            currentDay += delta * daysInCurrentMonth;
            updateDisplay();
            markDirty();
        }

        //
        // Moons' State
        //
        const lunaCycle = 28;
        const celeneCycle = 91;
        const moonPhases = ["New", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full", "Waning Gibbous", "Last Quarter", "Waning Crescent"];

        const moonPhaseImages = {
            "New": "moon-new.svg",
            "Waxing Crescent": "moon-waxing-crescent.svg",
            "First Quarter": "moon-first-quarter.svg",
            "Waxing Gibbous": "moon-waxing-gibbous.svg",
            "Full": "moon-full.svg",
            "Waning Gibbous": "moon-waning-gibbous.svg",
            "Last Quarter": "moon-last-quarter.svg",
            "Waning Crescent": "moon-waning-crescent.svg"
        };

        function getMoonPhase(day, cycleLength, offset = lastKingTide) {
            const adjustedDay = (day + offset + cycleLength) % cycleLength;
            const phaseIndex = Math.floor(adjustedDay / (cycleLength / moonPhases.length));
            return moonPhases[phaseIndex];
        }
        //
        // Weather
        //
        const monthWeather = {
            'Fireseek': { base: 32, high: 'd10', low: 'd20', precip: 46, sky: [23, 50], sunrise: '7:21', sunset: '5:01' },
            'Readying': { base: 34, high: 'd6+4', low: 'd10+4', precip: 40, sky: [25, 50], sunrise: '6:55', sunset: '5:36' },
            'Coldeven': { base: 42, high: 'd8+4', low: 'd10+4', precip: 44, sky: [27, 54], sunrise: '6:12', sunset: '6:09' },
            'Planting': { base: 52, high: 'd10+6', low: 'd8+4', precip: 42, sky: [20, 55], sunrise: '5:24', sunset: '6:39' },
            'Flocktime': { base: 63, high: 'd10+6', low: 'd10+6', precip: 42, sky: [20, 53], sunrise: '4:45', sunset: '7:10' },
            'Wealsun': { base: 71, high: 'd8+8', low: 'd6', precip: 36, sky: [20, 60], sunrise: '4:32', sunset: '7:32' },
            'Reaping': { base: 77, high: 'd6+4', low: 'd6+6', precip: 33, sky: [22, 62], sunrise: '4:45', sunset: '7:29' },
            'Goodmonth': { base: 75, high: 'd4+6', low: 'd6+6', precip: 33, sky: [25, 60], sunrise: '5:13', sunset: '6:57' },
            'Harvester': { base: 68, high: 'd8+6', low: 'd8+6', precip: 33, sky: [33, 55], sunrise: '5:42', sunset: '6:10' },
            'Patchwall': { base: 57, high: 'd10+5', low: 'd10+5', precip: 36, sky: [35, 60], sunrise: '6:12', sunset: '5:21' },
            'Ready‚Äôreat': { base: 46, high: 'd10+4', low: 'd10+4', precip: 40, sky: [20, 50], sunrise: '6:46', sunset: '4:45' },
            'Sunsebb': { base: 33, high: 'd8+5', low: 'd20', precip: 43, sky: [25, 50], sunrise: '7:19', sunset: '4:36' }
        };

        function updateWeather() {
            const currentTime = currentDay;
            const timeOfDay = currentDay % 1; // Fractional part of day
            const dayOfYear = (Math.floor(currentTime) % totalDays + totalDays) % totalDays;

            // Adjust the temperature for the time of day
            const highTemp = weatherState.high;
            const lowTemp = weatherState.low;
            const tempAmplitude = (highTemp - lowTemp) / 2;
            const tempMidpoint = (highTemp + lowTemp) / 2;
            weatherState.temp = Math.round(tempMidpoint + tempAmplitude * Math.sin((timeOfDay * 2 * Math.PI) - Math.PI / 2));

            if (currentTime >= weatherState.timeToChangeWeather) {
                // Check continuation first
                if (weatherState.hasPrecip && weatherState.continuation) {
                    const roll = rollDice("d100");
                    if (roll <= parseInt(weatherState.continuation)) {
                        // Weather continues
                        weatherState.timeToChangeWeather = currentTime + rollDice("d4") / 24; // 1‚Äì4 hours
                        return;
                    }
                }

                // Generate New Temp
                const baseTemp = getBaseTemperature(dayOfYear) + getTemperatureOffset(currentLatitude);
                const highTemp = baseTemp + rollDice("d10") + 6;
                const lowTemp = baseTemp - rollDice("d8") - 4;
                const tempAmplitude = (highTemp - lowTemp) / 2;
                const tempMidpoint = (highTemp + lowTemp) / 2;

                weatherState.high = Math.round(highTemp);
                weatherState.low = Math.round(lowTemp);
                weatherState.temp = Math.round(tempMidpoint + tempAmplitude * Math.sin((timeOfDay * 2 * Math.PI) - Math.PI / 2));

                // Generate New Weather
                const skyDist = getSkyDistribution(dayOfYear);
                weatherState.skyRoll = rollDice("d100");
                weatherState.sky = getSkyCondition(weatherState.skyRoll, skyDist);

                weatherState.precipRoll = rollDice("d100");
                weatherState.hasPrecip = weatherState.precipRoll <= getPrecipChance(dayOfYear) && weatherState.sky === "Cloudy";

                if (weatherState.hasPrecip) {
                    const type = getPrecipitationType(baseTemp);
                    weatherState.precipType = type;

                    // Look up continuation value from type
                    const entry = precipitationTypes.find(e => e.type === type);
                    weatherState.continuation = entry?.continuation || "0%";
                    weatherState.windSpeed = entry?.windSpeed ? rollDice(entry.windSpeed) : null;
                } else {
                    weatherState.precipType = "";
                    weatherState.continuation = "0%";
                    weatherState.windSpeed = rollDice("d10");
                }

                weatherState.timeToChangeWeather = currentTime + rollDice("2d8") / 24; // ~9 hours
                weatherState.lastUpdateTime = currentTime;
                console.log(weatherState)
            }
        }

        //
        // Temperatures
        //
        function getBaseTemperature(day) {
            // Rough sine wave over the year (coldest at day 1/360, warmest ~180)
            return 50 + 25 * Math.sin((2 * Math.PI * (day - 80)) / totalDays);
        }

        function getTemperatureOffset(latitude) {
            const offset = (45 - latitude) * 2;
            return Math.max(-30, Math.min(30, offset));
        }

        //
        // Sky conditions and precipitation
        //
        const precipitationTypes = [
            {
                range: [1, 2],
                type: "Blizzard, heavy",
                min: null,
                max: 10,
                continuation: "60%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "6d8+40"
            },
            {
                range: [3, 5],
                type: "Blizzard",
                min: null,
                max: 20,
                continuation: "50%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "3d8+36"
            },
            {
                range: [6, 10],
                type: "Snowstorm, heavy",
                min: null,
                max: 25,
                continuation: "45%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "3d10"
            },
            {
                range: [11, 20],
                type: "Snowstorm, light",
                min: null,
                max: 35,
                continuation: "40%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "4d6"
            },
            {
                range: [21, 25],
                type: "Sleet storm",
                min: null,
                max: 35,
                continuation: "35%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "3d10"
            },
            {
                range: [26, 27],
                type: "Hailstorm",
                min: null,
                max: 65,
                continuation: "20%",
                rainbowChance: "2%",
                notAllowedIn: ["Fireseek", "Readying", "Coldeven", "Sunsebb"],
                windSpeed: "4d10"
            },
            {
                range: [28, 30],
                type: "Fog, heavy",
                min: 20,
                max: 60,
                continuation: "25%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "d20"
            },
            {
                range: [31, 38],
                type: "Fog, light",
                min: 30,
                max: 70,
                continuation: "25%",
                rainbowChance: "0%",
                notAllowedIn: [],
                windSpeed: "d10"
            },
            {
                range: [39, 40],
                type: "Mist",
                min: 30,
                max: null,
                continuation: "15%",
                rainbowChance: "5%",
                notAllowedIn: [],
                windSpeed: "d10"
            },
            {
                range: [41, 45],
                type: "Drizzle",
                min: 25,
                max: null,
                continuation: "30%",
                rainbowChance: "10%",
                notAllowedIn: [],
                windSpeed: "d20"
            },
            {
                range: [46, 60],
                type: "Rainstorm, light",
                min: 25,
                max: null,
                continuation: "35%",
                rainbowChance: "15%",
                notAllowedIn: [],
                windSpeed: "d20"
            },
            {
                range: [61, 70],
                type: "Rainstorm, heavy",
                min: 25,
                max: null,
                continuation: "35%",
                rainbowChance: "20%",
                notAllowedIn: [],
                windSpeed: "2d12+10"
            },
            {
                range: [71, 84],
                type: "Thunderstorm",
                min: 40,
                max: null,
                continuation: "35%",
                rainbowChance: "25%",
                notAllowedIn: [],
                windSpeed: "4d10"
            },
            {
                range: [85, 89],
                type: "Tropical storm",
                min: 55,
                max: null,
                continuation: "30%",
                rainbowChance: "15%",
                notAllowedIn: ["Needfest", "Fireseek", "Readying", "Coldeven", "Sunsebb"],
                windSpeed: "3d12+30"
            },
            {
                range: [90, 94],
                type: "Monsoon",
                min: 40,
                max: null,
                continuation: "40%",
                rainbowChance: "25%",
                notAllowedIn: ["Needfest", "Fireseek", "Readying", "Coldeven", "Sunsebb"],
                windSpeed: "6d10"
            },
            {
                range: [95, 97],
                type: "Gale",
                min: 55,
                max: null,
                continuation: "30%",
                rainbowChance: "5%",
                notAllowedIn: [],
                windSpeed: "6d8+40"
            },
            {
                range: [98, 100],
                type: "Hurricane",
                min: null,
                max: null,
                continuation: "15%",
                rainbowChance: "0%",
                notAllowedIn: ["Needfest", "Fireseek", "Readying", "Coldeven", "Sunsebb"],
                windSpeed: "7d10+70"
                // },
                // {
                //     range: [100, 100],
                //     type: "Special",
                //     min: null,
                //     max: null,
                //     continuation: "‚Äî",
                //     rainbowChance: "‚Äî",
                //     notAllowedIn: []
            }
        ];

        const skyConditionImages = {
            "Clear": {
                day: "weather-sunny.svg",
                night: "moon-clear.svg"
            },
            "Partly Cloudy": {
                day: "weather-partly-cloudy.svg",
                night: "moon-cloud.svg"
            },
            "Cloudy": {
                day: "weather-cloudy.svg",
                night: "weather-cloudy.svg" // same all day
            }
        };
        const precipitationImages = {
            "Blizzard, heavy": "weather-snowy-heavy.svg",
            "Blizzard": "weather-snowy.svg",
            "Snowstorm, heavy": "weather-snowy-heavy.svg",
            "Snowstorm, light": "weather-snowy.svg",
            "Sleet storm": "weather-snowy-rainy.svg",
            "Hailstorm": "weather-hail.svg",
            "Fog, heavy": "weather-fog.svg",
            "Fog, light": "weather-fog.svg",
            "Mist": "weather-fog.svg",
            "Drizzle": "weather-fog.svg",
            "Rainstorm, light": "weather-rainy.svg",
            "Rainstorm, heavy": "weather-pouring.svg",
            "Thunderstorm": "weather-lightning-rainy.svg",
            "Tropical storm": "weather-hurricane.svg",
            "Monsoon": "weather-pouring.svg",
            "Gale": "weather-windy-variant.svg",
            "Hurricane": "weather-hurricane.svg",
            "Special": "weather-special.svg",
            "": "weather-none.svg"
        }

        function getSkyCondition(roll, thresholds) {
            const [clearMax, partlyMax] = thresholds;
            if (roll <= clearMax) return "Clear";
            if (roll <= partlyMax) return "Partly Cloudy";
            return "Cloudy";
        }

        function getSkyDistribution(day) {
            const clear = 20 + 15 * Math.sin((2 * Math.PI * (day + 30) / totalDays));
            const partly = 40;
            const cloudy = 100 - (clear + partly);
            return [Math.round(clear), Math.round(clear + partly)];
        }

        function getPrecipChance(day) {
            const x = day;
            return Math.round(
                -1.50463e-10 * Math.pow(x, 5) +
                1.26005e-6 * Math.pow(x, 4) -
                0.0000352364 * Math.pow(x, 3) +
                0.00393427 * Math.pow(x, 2) -
                0.202342 * x +
                47.45312
            );
        }

        function getPrecipitationType(tempF) {
            const maxAttempts = 100;
            for (let i = 0; i < maxAttempts; i++) {
                const roll = rollDice("d100");
                for (const entry of precipitationTypes) {
                    const [minRoll, maxRoll] = entry.range;
                    if (roll >= minRoll && roll <= maxRoll) {
                        const tempOk = (entry.min === null || tempF >= entry.min) &&
                            (entry.max === null || tempF <= entry.max);
                        const currentDayOfYear = getDayInYear(currentDay);

                        const monthOk = !entry.notAllowedIn || !entry.notAllowedIn.includes(dayToMonth[currentDayOfYear].name);
                        if (tempOk && monthOk) {
                            return `${entry.type}`;
                        }
                    }
                }
            }
            return "";
        }
        const windEffects = [
            {
                range: [0, 29],
                land: "No effect",
                sea: "No effect",
                air: "No effect",
                battle: "No effect"
            },
            {
                range: [30, 44],
                land: "All travel slowed by 25%, torches will be blown out.",
                sea: "Sailing difficult; rowing impossible.",
                air: "Creatures eagle-size and below can't fly.",
                battle: "Missiles at ¬Ω range and -1 to hit."
            },
            {
                range: [45, 59],
                land: "All travel slowed by 50%, torches and small fires blown out.",
                sea: "Minor ship damage (d4 structural points), waves 3d6 ft.",
                air: "Man-sized creatures cannot fly.",
                battle: "Missiles at ¬º range and -3 to hit."
            },
            {
                range: [60, 74],
                land: "Small trees uprooted, travel slowed by 75%, roofs may be torn off.",
                sea: "Ships endangered (d10 structural damage), waves d10+20 ft.",
                air: "No creatures can fly, except those from the Elemental Plane of Air.",
                battle: "No missile fire, -1 to hit with non-magical weapons, dex bonuses to AC canceled."
            },
            {
                range: [75, 200], // upper cap
                land: "Only strong stone buildings are safe; travel impossible.",
                sea: "Ships capsized and sunk, wave height d20+20 ft or more.",
                air: "No creatures can fly (except from the Elemental Plane of Air).",
                battle: "No missile fire; -3 to hit; 20% chance weapon torn away; dex bonuses to AC canceled."
            }
        ];
        function getWindEffect(speed) {
            return windEffects.find(e => speed >= e.range[0] && speed <= e.range[1]);
        }
        function createWindTooltip(speed) {
            const e = getWindEffect(speed);
            if (!e) return '';

            return `
                    <dl class="wind-tooltip-content">
                        <dt>üåç On land</dt><dd>${e.land}</dd>
                        <dt>üåä At sea</dt><dd>${e.sea}</dd>
                        <dt>üå¨Ô∏è In air</dt><dd>${e.air}</dd>
                        <dt>‚öîÔ∏è In battle</dt><dd>${e.battle}</dd>
                    </dl>
                `;
        }
        //
        // Sun Position
        //
        function getSolarDeclination(day) {
            return -23.44 * Math.cos((2 * Math.PI / totalDays) * (day + 10));
        }

        function getDaylightHours(day, latitude = 45) {
            const rad = Math.PI / 180;
            const phi = latitude * rad;
            const delta = getSolarDeclination(day) * rad;

            const cosH = -Math.tan(phi) * Math.tan(delta);
            const H = Math.acos(Math.min(Math.max(cosH, -1), 1)); // Clamp to avoid NaNs

            const daylightHours = (2 * H * 180 / Math.PI) / 15; // convert radians to hours
            return daylightHours;
        }

        function getSunrise(day) {
            return (12 - getDaylightHours(day, currentLatitude) / 2).toFixed(2);
        }

        function getSunset(day) {
            return (12 + getDaylightHours(day, currentLatitude) / 2).toFixed(2);
        }

        //
        // Tides
        //
        function getTideHeight(time) {
            const sunBase = Math.sin(2 * Math.PI * time - lastKingTide)
            const lunaBase = Math.sin(2 * (28 - 1) / 28 * Math.PI * time - lastKingTide)
            const celeneBase = Math.sin(2 * (91 - 1) / 91 * Math.PI * time - lastKingTide)

            const strength = lunaBase + celeneBase / 2 + sunBase / 4;
            return strength * 5; // ‚Üí ‚Äì8.75ft to +8.75ft
        }

        function getTideInfo(currentDay) {
            const currentHeight = getTideHeight(currentDay);
            const step = 1 / 96; // 15 minutes
            const endTime = currentDay + 1; // look ahead 1 day

            let max = { time: currentDay, height: currentHeight };
            let min = { time: currentDay, height: currentHeight };

            for (let t = currentDay + step; t <= endTime; t += step) {
                const h = getTideHeight(t);
                if (h > max.height) {
                    max = { time: t, height: h };
                }
                if (h < min.height) {
                    min = { time: t, height: h };
                }
            }

            return {
                now: { time: currentDay, height: currentHeight },
                nextHigh: max,
                nextLow: min
            };
        }


        //
        // GUI Updates
        //
        function updateDisplay() {
            const weekdays = ["Starday", "Sunday", "Moonday", "Godsday", "Waterday", "Earthday", "Freeday"];
            const year = 576 + Math.floor(currentDay / totalDays);
            const weekdayName = weekdays[(Math.floor(currentDay) % 7 + 7) % 7];
            const currentDayOfYear = getDayInYear(currentDay);

            const { name: displayMonth, day: displayDay } = dayToMonth[currentDayOfYear];

            const totalTenths = Math.round(currentDay * 14400); // 1440 minutes * 10 tenths
            const hours = Math.floor(totalTenths / 600) % 24;
            const minutes = Math.floor((totalTenths % 600) / 10);
            const tenths = totalTenths % 10;

            const timeStr = `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}.` +
                `${tenths}`;

            document.getElementById('display-day').textContent = displayDay;
            document.getElementById('display-month').textContent = displayMonth;
            document.getElementById('display-year').textContent = year;
            document.getElementById('display-hour').textContent = timeStr;

            // Display Moon State
            const luna = getMoonPhase(currentDay, lunaCycle);
            const celene = getMoonPhase(currentDay, celeneCycle);
            const sunrise = getSunrise(currentDayOfYear);
            const sunset = getSunset(currentDayOfYear);

            document.getElementById('celestial-info').innerHTML = `
                <tr><th>Luna</th><th>Celene</th><th>Sunrise</th><th>Sunset</th></tr>
                <tr class="icon-row">
                    <td><img src="images/moons/${moonPhaseImages[luna]}"></td>
                    <td><img src="images/moons/${moonPhaseImages[celene]}"></td>
                    <td><img src="images/sun/sunrise.svg"></td>
                    <td><img src="images/sun/sunset.svg"></td>
                </tr>
                <tr class="icon-label-row">
                    <td>${luna}</td>
                    <td>${celene}</td>
                    <td>${formatHour(sunrise)}</td>
                    <td>${formatHour(sunset)}</td>
                </tr>
            `;

            // Display Weather - Sunrise/Sunset
            updateWeather();

            const currentHour = (currentDay % 1) * 24;
            const isDaytime = currentHour >= sunrise && currentHour < sunset;
            const skyIcon = skyConditionImages[weatherState.sky][isDaytime ? "day" : "night"];

            document.getElementById('weekday-display').textContent = weekdayName;
            document.getElementById('weather-info').innerHTML = `
                <tr class="weather-display-row">
                    <td>
                        <div>
                            <img src="images/weather/thermometer.svg">
                            <div>${weatherState.temp} ‚Ñâ</div>
                        </div>
                    </td>
                    <td>
                        <img src="images/weather/${skyIcon}">
                        <div>${weatherState.sky}</div>
                    </td>
                    <td>
                        <img src="images/weather/${precipitationImages[weatherState.precipType]}">
                        <div>${weatherState.precipType}</div>
                    </td>
                    <td>
                        <div class="tooltip-wrapper" id="wind-icon">
                        <img src="images/weather/weather-windy.svg">
                        <div class="tooltip-box" id="wind-tooltip"></div>
                        </div>
                        <div>${weatherState.windSpeed} mph</div>
                    </td>
                </tr>
            `;

            // Display Tides
            const tide = getTideInfo(currentDay);
            document.getElementById('tide-info').innerHTML = `
                <tr><td><img src="images/tide/tides-moon.svg"></td><td><img src="images/tide/low-tide.svg"></td><td><img src="images/tide/high-tide.svg"></td></tr>
                <tr><td>Current</td><td>${formatHour((tide.nextLow.time % 1) * 24)}</td><td>${formatHour((tide.nextHigh.time % 1) * 24)}</td></tr>
                <tr><td>${tide.now.height.toFixed(1)} ft</td><td>${tide.nextLow.height.toFixed(1)} ft</td><td>${tide.nextHigh.height.toFixed(1)} ft</td></tr>
            `;

            // Create Wind tool tip
            const windIcon = document.getElementById('wind-icon');
            const windTooltip = document.getElementById('wind-tooltip');

            if (windIcon && windTooltip) {
                windIcon.addEventListener('mouseenter', () => {
                    windTooltip.innerHTML = createWindTooltip(weatherState.windSpeed);
                    windTooltip.style.display = 'block';
                });

                windIcon.addEventListener('mouseleave', () => {
                    windTooltip.style.display = 'none';
                });
            }
        }

        //
        // Event Listeners
        //
        function enableHoldToRepeat(button, callback, initialDelay = 400, repeatRate = 150) {
            let interval = null;
            let holdTimeout = null;
            let startTime = null;
            let holding = false;

            const start = () => {
                holding = false;
                startTime = Date.now();
                holdTimeout = setTimeout(() => {
                    holding = true;
                    interval = setInterval(callback, repeatRate);
                }, initialDelay);
            };

            const stop = () => {
                clearTimeout(holdTimeout);
                clearInterval(interval);

                const elapsed = Date.now() - startTime;

                // Only treat as a single click if the hold threshold wasn't passed
                if (elapsed < initialDelay) {
                    callback();
                }
            };

            button.addEventListener('mousedown', start);
            button.addEventListener('touchstart', start);

            button.addEventListener('mouseup', stop);
            button.addEventListener('mouseleave', stop);
            button.addEventListener('touchend', stop);
        }

        window.addEventListener("DOMContentLoaded", () => {
            enableHoldToRepeat(document.getElementById('btn-hour-up'), () => changeHours(1));
            enableHoldToRepeat(document.getElementById('btn-hour-down'), () => changeHours(-1));
            enableHoldToRepeat(document.getElementById('btn-minute-up'), () => changeMinutes(1));
            enableHoldToRepeat(document.getElementById('btn-minute-down'), () => changeMinutes(-1));
            enableHoldToRepeat(document.getElementById('btn-round-up'), () => changeRounds(1));
            enableHoldToRepeat(document.getElementById('btn-round-down'), () => changeRounds(-1));

            enableHoldToRepeat(document.getElementById('btn-day-up'), () => changeDays(1));
            enableHoldToRepeat(document.getElementById('btn-day-down'), () => changeDays(-1));

            enableHoldToRepeat(document.getElementById('btn-month-up'), () => changeMonths(1));
            enableHoldToRepeat(document.getElementById('btn-month-down'), () => changeMonths(-1));

            enableHoldToRepeat(document.getElementById('btn-year-up'), () => changeYears(1));
            enableHoldToRepeat(document.getElementById('btn-year-down'), () => changeYears(-1));

            document.getElementById("btn-save-state").addEventListener("click", saveStateToFile);

            document.getElementById("btn-load-state").addEventListener("click", () => {
                document.getElementById("file-input").click();
            });

            document.getElementById("file-input").addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (file) {
                    loadStateFromFile(file);
                }
            });
            const latitudeSlider = document.getElementById('latitude-slider');
            const latitudeValue = document.getElementById('latitude-value');

            latitudeSlider.addEventListener('input', () => {
                currentLatitude = parseFloat(latitudeSlider.value);
                latitudeValue.textContent = `${currentLatitude}¬∞`;
                updateDisplay();
                markDirty();
            });

        });

        updateDisplay();

    </script>
</body>

</html>