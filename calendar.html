<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Greyhawk Calendar</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f0f0f0;
            padding: 2rem;
            text-align: center;
        }

        .calendar {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            display: inline-block;
        }

        .display {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .datetime-group {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .datetime-field {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .controls button {
            padding: 0.25rem 0.5rem;
            font-size: 0.5rem;
        }

        button {
            margin: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.5rem;
        }

        .date-part {
            font-size: 1.5rem;
            font-weight: bold;
            /* padding: 0.25rem 0.5rem; */
            /* background-color: #f8f8f8; */
            /* border: 1px solid #ccc; */
            /* border-radius: 0.25rem; */
            min-width: 80px;
            text-align: center;
        }

        .moon-phase-table table {
            width: auto;
            margin: 0 auto;
        }

        /* .moon-phase-table th,
        .moon-phase-table td {
            text-align: center;
            vertical-align: middle;
        } */

        .moon-phase-table td {
            width: 120px;
            /* adjust as needed */
            padding: 0.5rem;
            vertical-align: middle;
        }

        .moon-phase-table img {
            display: block;
            margin: 0 auto 0.25rem;
            width: 48px;
            /* or whatever consistent size you prefer */
            height: auto;
        }

        .moon-cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* centers the whole block vertically */
            align-items: center;
            /* centers content horizontally */
            height: 100px;
            /* or however tall you want each cell */
        }

        .moon-cell img {
            width: 48px;
            height: auto;
            flex-shrink: 0;
        }

        .moon-label {
            margin-top: auto;
            /* pushes text to bottom of moon-cell */
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="calendar">
        <h1>Greyhawk Calendar</h1>
        <div class="datetime-group">
            <div class="datetime-field">
                <div class="label">Year</div>
                <div class="controls">
                    <button onclick="changeYears(1)">&#9650;</button>
                    <div id="display-year" class="date-part"></div>
                    <button onclick="changeYears(-1)">&#9660;</button>
                </div>
            </div>
            <div class="datetime-field">
                <div class="label">Month</div>
                <div class="controls">
                    <button onclick="changeMonths(1)">&#9650;</button>
                    <div id="display-month" class="date-part"></div>
                    <button onclick="changeMonths(-1)">&#9660;</button>
                </div>
            </div>
            <div class="datetime-field">
                <div class="label">Day</div>
                <div class="controls">
                    <button onclick="changeDays(1)">&#9650;</button>
                    <div id="display-day" class="date-part"></div>
                    <button onclick="changeDays(-1)">&#9660;</button>
                </div>
            </div>
            <div class="datetime-field">
                <div class="label">Hour</div>
                <div class="controls">
                    <button onclick="changeHours(1)">&#9650;</button>
                    <div id="display-hour" class="date-part"></div>
                    <button onclick="changeHours(-1)">&#9660;</button>
                </div>
            </div>
        </div>
        <div class="moon-phase-table">
            <table id="moon-phases"></table>
        </div>
        <div class="display" id="weather-info"></div>
    </div>

    <script>
        const monthWeather = {
            'Fireseek': { base: 32, high: 'd10', low: 'd20', precip: 46, sky: [23, 50], sunrise: '7:21', sunset: '5:01' },
            'Readying': { base: 34, high: 'd6+4', low: 'd10+4', precip: 40, sky: [25, 50], sunrise: '6:55', sunset: '5:36' },
            'Coldeven': { base: 42, high: 'd8+4', low: 'd10+4', precip: 44, sky: [27, 54], sunrise: '6:12', sunset: '6:09' },
            'Planting': { base: 52, high: 'd10+6', low: 'd8+4', precip: 42, sky: [20, 55], sunrise: '5:24', sunset: '6:39' },
            'Flocktime': { base: 63, high: 'd10+6', low: 'd10+6', precip: 42, sky: [20, 53], sunrise: '4:45', sunset: '7:10' },
            'Wealsun': { base: 71, high: 'd8+8', low: 'd6', precip: 36, sky: [20, 60], sunrise: '4:32', sunset: '7:32' },
            'Reaping': { base: 77, high: 'd6+4', low: 'd6+6', precip: 33, sky: [22, 62], sunrise: '4:45', sunset: '7:29' },
            'Goodmonth': { base: 75, high: 'd4+6', low: 'd6+6', precip: 33, sky: [25, 60], sunrise: '5:13', sunset: '6:57' },
            'Harvester': { base: 68, high: 'd8+6', low: 'd8+6', precip: 33, sky: [33, 55], sunrise: '5:42', sunset: '6:10' },
            'Patchwall': { base: 57, high: 'd10+5', low: 'd10+5', precip: 36, sky: [35, 60], sunrise: '6:12', sunset: '5:21' },
            'Ready’reat': { base: 46, high: 'd10+4', low: 'd10+4', precip: 40, sky: [20, 50], sunrise: '6:46', sunset: '4:45' },
            'Sunsebb': { base: 33, high: 'd8+5', low: 'd20', precip: 43, sky: [25, 50], sunrise: '7:19', sunset: '4:36' }
        };
        const calendarStructure = [
            { name: "Needfest", days: 6 },
            { name: "Fireseek", days: 28 },
            { name: "Readying", days: 28 },
            { name: "Coldeven", days: 28 },
            { name: "Growfest", days: 6 },
            { name: "Planting", days: 28 },
            { name: "Flocktime", days: 28 },
            { name: "Wealsun", days: 28 },
            { name: "Richfest", days: 6 },
            { name: "Reaping", days: 28 },
            { name: "Goodmonth", days: 28 },
            { name: "Harvester", days: 28 },
            { name: "Brewfest", days: 6 },
            { name: "Patchwall", days: 28 },
            { name: "Ready’reat", days: 28 },
            { name: "Sunsebb", days: 28 }
        ];


        const dayToMonth = []; // index: 0–359 → { name, day }

        (function generateDayMapping() {
            let dayOfYear = 0;
            for (const entry of calendarStructure) {
                for (let i = 1; i <= entry.days; i++) {
                    dayToMonth.push({ name: entry.name, day: i });
                    dayOfYear++;
                }
            }
        })();

        const moonPhaseImages = {
            "New": "moon-new.svg",
            "Waxing Crescent": "moon-waxing-crescent.svg",
            "First Quarter": "moon-first-quarter.svg",
            "Waxing Gibbous": "moon-waxing-gibbous.svg",
            "Full": "moon-full.svg",
            "Waning Gibbous": "moon-waning-gibbous.svg",
            "Last Quarter": "moon-last-quarter.svg",
            "Waning Crescent": "moon-waning-crescent.svg"
        };
        const daysPerMonth = 28;
        const totalDays = 360;

        let currentDay = 0; // total day count since CY 576
        let currentHour = 12;
        let currentYear = 576;

        let weatherState = {
            day: null,
            temp: null,
            high: null,
            low: null,
            skyRoll: null,
            sky: null,
            precipRoll: null,
            hasPrecip: false,
            precipType: "None",
            lastSkyUpdateHour: null,
        };


        const lunaCycle = 28;
        const celeneCycle = 91;
        const moonPhases = ["New", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full", "Waning Gibbous", "Last Quarter", "Waning Crescent"];

        function getMoonPhase(day, cycleLength) {
            const phaseIndex = Math.floor((day % cycleLength + cycleLength) % cycleLength / (cycleLength / moonPhases.length));
            return moonPhases[phaseIndex];
        }


        function getCalendarDate(dayOffset) {
            const dayInYear = (dayOffset % 360 + 360) % 360;
            const entry = dayToMonth[dayInYear];
            return `${entry.day} ${entry.name}`;
        }

        function getSkyCondition(roll, thresholds) {
            const [clearMax, partlyMax] = thresholds;
            if (roll <= clearMax) return "Clear";
            if (roll <= partlyMax) return "Partly Cloudy";
            return "Cloudy";
        }

        function getBaseTemperature(day) {
            // Rough sine wave over the year (coldest at day 1/360, warmest ~180)
            return 50 + 25 * Math.sin((2 * Math.PI * (day - 80)) / 360);
        }

        function getPrecipChance(day) {
            const x = day;
            return Math.round(
                -1.50463e-10 * Math.pow(x, 5) +
                1.26005e-6 * Math.pow(x, 4) -
                0.0000352364 * Math.pow(x, 3) +
                0.00393427 * Math.pow(x, 2) -
                0.202342 * x +
                47.45312
            );
        }
        function getSkyDistribution(day) {
            const clear = 20 + 15 * Math.sin((2 * Math.PI * (day + 30) / 360));
            const partly = 40;
            const cloudy = 100 - (clear + partly);
            return [Math.round(clear), Math.round(clear + partly)];
        }

        function getSolarDeclination(day) {
            return -23.44 * Math.cos((2 * Math.PI / 360) * (day + 10));
        }

        function getDaylightHours(day, latitude = 45) {
            const rad = Math.PI / 180;
            const phi = latitude * rad;
            const delta = getSolarDeclination(day) * rad;

            const cosH = -Math.tan(phi) * Math.tan(delta);
            const H = Math.acos(Math.min(Math.max(cosH, -1), 1)); // Clamp to avoid NaNs

            const daylightHours = (2 * H * 180 / Math.PI) / 15; // convert radians to hours
            return daylightHours;
        }

        function getSunrise(day) {
            return (12 - getDaylightHours(day) / 2).toFixed(2);
        }

        function getSunset(day) {
            return (12 + getDaylightHours(day) / 2).toFixed(2);
        }
        function getPrecipitationType(tempF) {
            const precipitationTypes = [
                {
                    range: [1, 2],
                    type: "Blizzard, heavy",
                    min: null,
                    max: 10,
                    continuation: "60%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [3, 5],
                    type: "Blizzard",
                    min: null,
                    max: 20,
                    continuation: "50%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [6, 10],
                    type: "Snowstorm, heavy",
                    min: null,
                    max: 25,
                    continuation: "45%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [11, 20],
                    type: "Snowstorm, light",
                    min: null,
                    max: 35,
                    continuation: "40%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [21, 25],
                    type: "Sleet storm",
                    min: null,
                    max: 35,
                    continuation: "35%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [26, 27],
                    type: "Hailstorm",
                    min: null,
                    max: 65,
                    continuation: "20%",
                    rainbowChance: "2%",
                    notAllowedIn: ["Fireseek", "Readying", "Coldeven", "Sunsebb"]
                },
                {
                    range: [28, 30],
                    type: "Fog, heavy",
                    min: 20,
                    max: 60,
                    continuation: "25%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [31, 38],
                    type: "Fog, light",
                    min: 30,
                    max: 70,
                    continuation: "25%",
                    rainbowChance: "0%",
                    notAllowedIn: []
                },
                {
                    range: [39, 40],
                    type: "Mist",
                    min: 30,
                    max: null,
                    continuation: "15%",
                    rainbowChance: "5%",
                    notAllowedIn: []
                },
                {
                    range: [41, 45],
                    type: "Drizzle",
                    min: 25,
                    max: null,
                    continuation: "30%",
                    rainbowChance: "10%",
                    notAllowedIn: []
                },
                {
                    range: [46, 60],
                    type: "Rainstorm, light",
                    min: 25,
                    max: null,
                    continuation: "35%",
                    rainbowChance: "15%",
                    notAllowedIn: []
                },
                {
                    range: [61, 70],
                    type: "Rainstorm, heavy",
                    min: 25,
                    max: null,
                    continuation: "35%",
                    rainbowChance: "20%",
                    notAllowedIn: []
                },
                {
                    range: [71, 84],
                    type: "Thunderstorm",
                    min: 40,
                    max: null,
                    continuation: "35%",
                    rainbowChance: "25%",
                    notAllowedIn: []
                },
                {
                    range: [85, 89],
                    type: "Tropical storm",
                    min: 55,
                    max: null,
                    continuation: "30%",
                    rainbowChance: "15%",
                    notAllowedIn: ["Fireseek", "Readying", "Coldeven", "Sunsebb"]
                },
                {
                    range: [90, 94],
                    type: "Monsoon",
                    min: 40,
                    max: null,
                    continuation: "40%",
                    rainbowChance: "25%",
                    notAllowedIn: ["Fireseek", "Readying", "Coldeven", "Sunsebb"]
                },
                {
                    range: [95, 97],
                    type: "Gale",
                    min: 55,
                    max: null,
                    continuation: "30%",
                    rainbowChance: "5%",
                    notAllowedIn: []
                },
                {
                    range: [98, 99],
                    type: "Hurricane or typhoon",
                    min: null,
                    max: null,
                    continuation: "15%",
                    rainbowChance: "0%",
                    notAllowedIn: ["Fireseek", "Readying", "Coldeven", "Sunsebb"]
                },
                {
                    range: [100, 100],
                    type: "Special",
                    min: null,
                    max: null,
                    continuation: "—",
                    rainbowChance: "—",
                    notAllowedIn: []
                }
            ];
            const maxAttempts = 100;
            for (let i = 0; i < maxAttempts; i++) {
                const roll = rollDice("d100");
                for (const entry of precipitationTypes) {
                    const [minRoll, maxRoll] = entry.range;
                    if (roll >= minRoll && roll <= maxRoll) {
                        const tempOk = (entry.min === null || tempF >= entry.min) &&
                            (entry.max === null || tempF <= entry.max);
                        const monthOk = !entry.notAllowedIn || !entry.notAllowedIn.includes(dayToMonth[currentDay % 360].name);
                        if (tempOk && monthOk) {
                            return `${entry.type}`;
                        }
                    }
                }
            }
            return "None";
        }


        function updateDisplay() {
            const weekdays = ["Starday", "Sunday", "Moonday", "Godsday", "Waterday", "Earthday", "Freeday"];
            const year = currentYear + Math.floor(currentDay / totalDays);
            const dateStr = getCalendarDate(currentDay);
            const hourStr = `${(currentHour + 24) % 24}:00`;
            const weekdayName = weekdays[(currentDay % 7 + 7) % 7];
            const currentDayOfYear = (currentDay % totalDays + totalDays) % totalDays;
            const isNewDay = weatherState.day !== currentDayOfYear;
            const hourNow = (currentHour + 24) % 24;

            const baseTemp = Math.round(getBaseTemperature(currentDayOfYear));
            const highDelta = rollDice("d10") + 6;
            const lowDelta = rollDice("d8") + 4;
            const high = baseTemp + highDelta;
            const low = baseTemp - lowDelta;

            const { name: displayMonth, day: displayDay } = dayToMonth[currentDayOfYear];

            document.getElementById('display-day').textContent = displayDay;
            document.getElementById('display-month').textContent = displayMonth;
            document.getElementById('display-year').textContent = year;
            document.getElementById('display-hour').textContent = hourStr;

            const luna = getMoonPhase(currentDay, lunaCycle);
            const celene = getMoonPhase(currentDay, celeneCycle);
            document.getElementById('moon-phases').innerHTML = `
                <tr><th>Luna</th><th>Celene</th></tr>
                <tr>
                    <td>
                        <img src="images/moons/${moonPhaseImages[luna]}" alt="${luna}" title="${luna}" width="48"><br>
                        <div class="moon-label">${luna}</div>
                    </td>
                    <td>
                        <img src="images/moons/${moonPhaseImages[celene]}" alt="${celene}" title="${celene}" width="48"><br>
                        <div class="moon-label">${celene}</div>
                    </td>
                </tr>
                `;

            const precipChance = getPrecipChance(currentDayOfYear); // You’ll define this
            const skyTable = getSkyDistribution(currentDayOfYear);  // You’ll define this


            const sunrise = getSunrise(currentDayOfYear);
            const sunset = getSunset(currentDayOfYear);

            if (isNewDay) {
                weatherState.day = currentDayOfYear;

                const base = getBaseTemperature(currentDayOfYear);
                const highAdj = rollDice("d10") + 6;
                const lowAdj = rollDice("d8") + 4;

                weatherState.high = Math.round(base + highAdj);
                weatherState.low = Math.round(base - lowAdj);
                weatherState.temp = Math.round((weatherState.high + weatherState.low) / 2);

                const skyDist = getSkyDistribution(currentDayOfYear);
                weatherState.skyRoll = rollDice("d100");
                weatherState.sky = getSkyCondition(weatherState.skyRoll, skyDist);

                weatherState.precipRoll = rollDice("d100");
                weatherState.hasPrecip = weatherState.precipRoll <= getPrecipChance(currentDayOfYear) && weatherState.sky === "Cloudy";

                weatherState.precipType = weatherState.hasPrecip
                    ? getPrecipitationType(base)
                    : "None";
            }

            // Drift sky hourly
            if (!isNewDay && weatherState.lastSkyUpdateHour !== hourNow) {
                if (Math.random() < 0.3) {
                    const delta = rollDice("d6") - 3;
                    weatherState.skyRoll = Math.max(1, Math.min(100, weatherState.skyRoll + delta));
                    weatherState.sky = getSkyCondition(weatherState.skyRoll, getSkyDistribution(currentDayOfYear));
                }
                weatherState.lastSkyUpdateHour = hourNow;
            }

            // Display
            document.getElementById('weather-info').innerHTML = `
                <strong>Weather for ${weekdayName}</strong><br>
                Temp: High: ${weatherState.high}, Low: ${weatherState.low}<br>
                Precipitation: ${weatherState.precipType}<br>
                Sky: ${weatherState.sky}<br>
                Sunrise: ${sunrise}, Sunset: ${sunset}
            `;
        }

        function changeDays(delta) {
            currentDay += delta;
            updateDisplay();
        }

        function changeHours(delta) {
            currentHour += delta;
            while (currentHour < 0) {
                currentHour += 24;
                changeDays(-1);
            }
            while (currentHour >= 24) {
                currentHour -= 24;
                changeDays(1);
            }
            updateDisplay();
        }
        function getMonthIndex(dayInYear) {
            let dayCount = 0;
            for (let i = 0; i < calendarStructure.length; i++) {
                const monthLength = calendarStructure[i].days;
                if (dayInYear < dayCount + monthLength) {
                    return i;
                }
                dayCount += monthLength;
            }
            return calendarStructure.length - 1; // fallback
        }
        function changeMonths(delta) {
            const dayInYear = (currentDay % totalDays + totalDays) % totalDays;
            const currentMonth = getMonthIndex(dayInYear);
            const currentOffset = dayInYear - calendarStructure
                .slice(0, currentMonth)
                .reduce((a, m) => a + m.days, 0);

            let newMonth = currentMonth + delta;
            if (newMonth < 0) {
                newMonth += calendarStructure.length;
                currentYear -= 1;
            } else if (newMonth >= calendarStructure.length) {
                newMonth -= calendarStructure.length;
                currentYear += 1;
            }

            const newMonthStart = calendarStructure
                .slice(0, newMonth)
                .reduce((a, m) => a + m.days, 0);

            const newOffset = Math.min(currentOffset, calendarStructure[newMonth].days - 1);
            currentDay = (currentYear - 576) * totalDays + newMonthStart + newOffset;

            updateDisplay();
        }
        function changeYears(delta) {
            currentDay += delta * totalDays;
            updateDisplay();
        }

        function rollDice(expr) {
            const match = expr.match(/d(\d+)([+-]\d+)?/);
            if (!match) return 0;
            const sides = parseInt(match[1]);
            const bonus = match[2] ? parseInt(match[2]) : 0;
            return Math.floor(Math.random() * sides) + 1 + bonus;
        }

        updateDisplay();
    </script>
</body>

</html>